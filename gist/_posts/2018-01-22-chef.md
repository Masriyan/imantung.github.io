---
layout: gist
---

- Configuration manager (CM)

[Official Web](https://www.chef.io/)

[Why Configuration Manager?](https://www.upguard.com/articles/the-7-configuration-management-tools-you-need-to-know)

### Quotes

> Turn your infrastructure into code

### Basic Concept

Cookbook --> project configuration

Workstation --> your local where you setup/manage cookbook
- `Check DK` Development Kit
- `Chef-Repo` Working directory contains Cookbooks, Roles, Data bags, environments, etc.
- `Chef` tool to manage cookbook
- `Knife` tool to communicate with ChefServer

Chef Server --> a hub for a configuration data
- [Server Component](https://docs.chef.io/server_components.html)
- `ChefSupermarket` community cookbook that free to use

Nodes --> machines that are managed/configurated by Chef
- `ChefClient`
- `Ohai` collect system configuration data

[Knife Cheatsheet](https://github.com/chef/quick-reference/blob/master/qr_knife_web.png)

### Chef-Repo

[Chef Repo Doc](https://docs.chef.io/chef_repo.html)

Directory structure
- `.chef` validation key files and `knife.rb`
- `cookbooks`
- `data_bags` global variable
- `environments`
- `roles`

[knife.rb Doc](https://docs.chef.io/config_rb_knife.html)

`knife.rb` -> configuration details for knife
  - Is loaded every time this executable is run
  - Is not created by default
  - Default path: `.chef/chef.rb`

`cookbooks` folder can be added to `.gitignore`


### Setup Workstation

[Official docs](https://docs.chef.io/workstation.html)

1. Install [Chef DK](https://downloads.chef.io/chefdk)
2. Create or Clone chef repo `git clone CHEF_REPO`
3. ssh to chef server
4. (If not exist) create organization `chef-server-ctl org-create ORG_NAME ORG_FULL_NAME -f FILE_NAME`. This step will generate `ORG_NAME.pem`
5. Create user `chef-server-ctl user-create USER_NAME FIRST_NAME LAST_NAME EMAIL PASSWORD -f FILE_NAME`. This step will generate `USERNAME.pem`
6. Add user to organization `sudo chef-server-ctl org-user-add ORG_NAME USER_NAME`
7. Exit from chef serve (back to your workstation)
8. Change directory to chef repo `cd CHEF_REPO`
9. Create .chef directory `mkdir .chef`
10. Move `ORG_NAME.pem` and `USERNAME.pem` to .chef directory
11. Setup your `knife.rb`
```rb
current_dir = File.dirname(__FILE__)
log_level                :info
log_location             STDOUT
node_name                'node_name'
client_key               "#{current_dir}/USER.pem"
validation_client_name   'ORG_NAME-validator'
validation_key           "#{current_dir}/ORGANIZATION-validator.pem"
chef_server_url          'https://api.chef.io/organizations/ORG_NAME'
cache_type               'BasicFile'
cache_options( :path => "#{ENV['HOME']}/.chef/checksums" )
cookbook_path            ["#{current_dir}/../cookbooks"]
```
12. Get SSL Certificate `knife ssl fetch`
13. Test `knife client list`

### Setup Node

Manual
```
ssh NODE -l USERNAME
sudo chef-client
```

Using `knife ssh`
```sh
# run chef-client on NODE
knife ssh 'name:NODE' 'sudo chef-client'

# run chef-client on all NODE
knife ssh 'name:*' 'sudo chef-client'

# run chef-client  on all of the web servers running Ubuntu on the Amazon EC2 platform
knife ssh "role:web" "sudo chef-client" -x ubuntu -a ec2.public_hostname

# upgrade all nodes
knife ssh name:* "sudo aptitude upgrade -y"
```

### Cookbook
